# Анализ многопоточной загрузки в downloader.py

## Текущая реализация

### ✅ Что работает правильно:

1. **Использование asyncio.Semaphore** - правильно ограничивает количество одновременных загрузок
2. **asyncio.gather()** - правильно запускает задачи параллельно
3. **Async/await функции** - правильно используются для асинхронных операций

### ❌ Проблемы:

#### 1. Блокирующие операции с базой данных

**Проблема**: Функции `document_has_content_in_db()` и `save_document_content_to_db()` используют синхронный `psycopg2`, который блокирует event loop.

```python
# Это блокирует event loop!
def document_has_content_in_db(document_id: str) -> bool:
    conn = psycopg2.connect(**DB_CONFIG)  # Блокирующий вызов
    cur = conn.cursor()
    cur.execute("SELECT COUNT(*) ...")  # Блокирующий вызов
    # ...
```

**Влияние**: При 5 параллельных загрузках каждая проверка БД блокирует другие задачи.

#### 2. Создание нового браузера для каждого документа

**Проблема**: Каждый документ создает свой собственный экземпляр `PlaywrightBulkHandler` с новым браузером:

```python
# В process_single_document():
handler = PlaywrightBulkHandler(...)  # Новый браузер для каждого документа!
await handler.navigate("/")
# ...
await handler.close()  # Закрывает браузер после каждого документа
```

**Влияние**: 
- Очень медленно (запуск браузера занимает 1-2 секунды)
- Высокое потребление памяти
- Неэффективное использование ресурсов

#### 3. Проверка БД внутри semaphore

**Проблема**: Проверка наличия документа в БД происходит внутри `async with semaphore:`, что блокирует слот для других загрузок:

```python
async with semaphore:  # Занимает слот
    if document_has_content_in_db(doc_id):  # Блокирующая операция!
        return  # Освобождает слот только после проверки
```

**Влияние**: Если документ уже загружен, слот занят впустую.

#### 4. Нет пула соединений с БД

**Проблема**: Каждая операция с БД создает новое соединение:

```python
conn = psycopg2.connect(**DB_CONFIG)  # Новое соединение каждый раз
# ...
conn.close()  # Закрывает соединение
```

**Влияние**: Медленно и неэффективно при множественных запросах.

## Рекомендации по улучшению

### 1. Использовать asyncpg вместо psycopg2

```python
import asyncpg

async def document_has_content_in_db_async(document_id: str) -> bool:
    conn = await asyncpg.connect(**DB_CONFIG)
    try:
        count = await conn.fetchval(
            "SELECT COUNT(*) FROM document_content WHERE document_id = $1",
            document_id
        )
        return count > 0
    finally:
        await conn.close()
```

### 2. Переиспользовать браузер или использовать пул контекстов

**Вариант A**: Использовать один браузер с несколькими контекстами:

```python
# Создать один браузер
browser = await playwright.chromium.launch(...)

# Для каждого документа создавать новый контекст
context = await browser.new_context()
page = await context.new_page()
# ... работа с документом
await context.close()  # Закрыть только контекст, не браузер
```

**Вариант B**: Использовать пул браузеров:

```python
# Создать пул из N браузеров
browser_pool = [await create_browser() for _ in range(concurrent_connections)]

# Брать браузер из пула для каждого документа
async with semaphore:
    browser = browser_pool.pop()
    # ... использовать браузер
    browser_pool.append(browser)  # Вернуть в пул
```

### 3. Проверять БД до получения semaphore

```python
# Проверить БД ДО получения семафора
if await document_has_content_in_db_async(doc_id):
    return {'skipped': True}

# Только если нужно загружать - получить семафор
async with semaphore:
    # Загрузка документа
    ...
```

### 4. Использовать пул соединений с БД

```python
# Создать пул при старте
db_pool = await asyncpg.create_pool(**DB_CONFIG)

# Использовать в функциях
async def save_to_db(...):
    async with db_pool.acquire() as conn:
        await conn.execute(...)
```

## Оценка производительности

### Текущая реализация:
- **Время на документ**: ~5-10 секунд (запуск браузера + загрузка)
- **При 5 параллельных**: ~1-2 секунды на документ (если нет блокировок)
- **Проблема**: Блокировки БД замедляют процесс

### С улучшениями:
- **Время на документ**: ~2-3 секунды (переиспользование браузера)
- **При 5 параллельных**: ~0.5-1 секунда на документ
- **Улучшение**: В 2-3 раза быстрее

## Приоритет исправлений

1. **Высокий**: Переместить проверку БД за пределы semaphore
2. **Высокий**: Переиспользовать браузер (контексты вместо новых браузеров)
3. **Средний**: Использовать asyncpg для асинхронных операций с БД
4. **Низкий**: Добавить пул соединений с БД
