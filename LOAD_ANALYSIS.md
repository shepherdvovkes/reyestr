# Анализ нагрузки: 10 клиентов × 20 одновременных вызовов

## Сценарий нагрузки

- **Клиентов**: 10
- **Одновременных вызовов на клиента**: 20
- **Максимальная нагрузка**: 200 одновременных запросов к серверу
- **База данных**: PostgreSQL (один сервер)

## Критические проблемы

### 1. Пул соединений с БД - КРИТИЧНО

**Текущая ситуация:**
- `server/database/connection.py:25` - `maxconn=10`
- При 200 одновременных запросах только 10 соединений доступны

**Проблема:**
- 190 запросов будут ждать свободного соединения
- Таймауты и ошибки при высокой нагрузке
- Блокировки и деградация производительности

**Решение:**
- Увеличить `maxconn` до 200-250 (с запасом)
- Добавить настройку через переменные окружения
- Настроить `minconn` для предварительного создания соединений

### 2. Кэширование - ОТСУТСТВУЕТ

**Что не кэшируется:**
- API запросы клиентов (запросы задач)
- Результаты SELECT запросов к БД
- Результаты регистрации документов
- Статистика клиентов

**Проблема:**
- Избыточная нагрузка на БД
- Медленные ответы при повторных запросах
- Нет оптимизации для часто запрашиваемых данных

**Решение:**
- Добавить Redis для кэширования
- Кэшировать:
  - Список pending задач (TTL 5-10 секунд)
  - Статистику клиентов (TTL 30 секунд)
  - Результаты поиска документов (TTL 60 секунд)

### 3. Backup/Restore - НЕ АВТОМАТИЗИРОВАН

**Текущая ситуация:**
- Есть только ручные команды в `database/README.md`
- Нет автоматических скриптов
- Нет расписания для регулярных бэкапов

**Проблема:**
- Риск потери данных при сбоях
- Нет возможности быстро восстановиться
- Нет версионирования бэкапов

**Решение:**
- Создать скрипт `backup_database.sh`
- Настроить cron для ежедневных бэкапов
- Добавить скрипт `restore_database.sh`
- Хранить бэкапы с датой в имени файла

### 4. Rate Limiting - ЧАСТИЧНО

**Текущая ситуация:**
- В `nginx.conf:102-105` есть rate limiting только для `/api/v1/tasks/request`
- Нет глобального rate limiting
- Нет защиты от DDoS

**Проблема:**
- Возможна перегрузка сервера
- Нет защиты от злоупотреблений
- Один клиент может заблокировать других

**Решение:**
- Добавить глобальный rate limiting для всех API эндпоинтов
- Настроить разные лимиты для разных эндпоинтов
- Добавить whitelist для доверенных клиентов

### 5. Синхронные операции с БД

**Текущая ситуация:**
- Используется `psycopg2` (синхронный)
- Блокирует event loop FastAPI
- Не оптимально для async/await

**Проблема:**
- Снижение производительности
- Блокировка других запросов во время операций с БД

**Решение (опционально, приоритет 2):**
- Рассмотреть переход на `asyncpg` для асинхронных операций
- Это требует рефакторинга всех операций с БД

## Дополнительные узкие места

### 6. Настройки PostgreSQL

**Проверить:**
- `max_connections` в PostgreSQL (по умолчанию 100)
- `shared_buffers` для кэширования
- `work_mem` для сортировок

**Решение:**
- Увеличить `max_connections` до 250-300
- Настроить `shared_buffers` = 25% RAM
- Оптимизировать `work_mem` для запросов

### 7. Отсутствие мониторинга

**Проблема:**
- Нет метрик производительности
- Нет алертов при проблемах
- Сложно диагностировать проблемы

**Решение:**
- Добавить логирование метрик
- Настроить мониторинг пула соединений
- Добавить health checks с детальной информацией

## План исправлений

### Приоритет 1 (Критично - исправить немедленно)

1. ✅ Увеличить пул соединений БД до 200-250
2. ✅ Добавить Redis для кэширования
3. ✅ Настроить автоматический backup БД

### Приоритет 2 (Важно - исправить в ближайшее время)

4. ✅ Добавить глобальный rate limiting
5. ✅ Добавить настройки пула в конфигурацию
6. ⚠️ Рассмотреть asyncpg (требует рефакторинга)

### Приоритет 3 (Желательно)

7. Настроить параметры PostgreSQL
8. Добавить мониторинг и метрики

## Ожидаемые результаты

После исправлений:
- ✅ Система выдержит 200 одновременных запросов
- ✅ Снизится нагрузка на БД благодаря кэшированию
- ✅ Улучшится производительность ответов
- ✅ Будет защита от потери данных
- ✅ Будет защита от перегрузки

## Тестирование

После исправлений необходимо протестировать:
1. Нагрузочное тестирование с 10 клиентами × 20 запросов
2. Проверка работы кэша
3. Проверка backup/restore процедур
4. Мониторинг использования пула соединений
