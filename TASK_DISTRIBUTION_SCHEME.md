# Схема распределения заданий по датам

## Обзор

Система позволяет автоматически создавать задачи для загрузки документов за определенный период (год), разбивая его на более мелкие периоды и распределяя их между клиентами.

## Принцип работы

### 1. Определение периода

Сначала определяем, за какой период нужно загрузить документы. Например, за прошлый год (2024).

### 2. Разбиение на периоды

Год разбивается на более мелкие периоды:
- **По месяцам** (рекомендуется) - 12 задач за год
- **По кварталам** - 4 задачи за год
- **По неделям** - ~52 задачи за год
- **По дням** - 365 задач за год (не рекомендуется для больших объемов)

### 3. Создание задач

Для каждого периода создается отдельная задача с параметрами:
- `RegDateBegin` - начало периода (например, "01.01.2024")
- `RegDateEnd` - конец периода (например, "31.01.2024")
- `start_page` - начальная страница (обычно 1)
- `max_documents` - максимальное количество документов на задачу

### 4. Распределение между клиентами

Сервер автоматически распределяет задачи между подключенными клиентами:
- Клиент запрашивает задачу через API
- Сервер назначает самую старую pending задачу
- Клиент обрабатывает задачу и сообщает о результате

## Использование

### Создание задач за год

```bash
# Создать задачи по месяцам за 2024 год
python create_tasks_by_date.py \
    --api-url http://localhost:8000 \
    --year 2024 \
    --period month \
    --api-key YOUR_API_KEY
```

### Параметры

- `--api-url` - URL сервера (обязательно)
- `--api-key` - API ключ для аутентификации (опционально)
- `--year` - Год для загрузки (обязательно, например, 2024)
- `--period` - Тип периода: `month`, `week`, `quarter`, `day` (по умолчанию: `month`)
- `--court-region` - ID региона суда (по умолчанию: 11 - Київська область)
- `--instance-type` - Тип инстанции: 1=Перша, 2=Апеляційна, 3=Касаційна (по умолчанию: 1)
- `--start-page` - Начальная страница (по умолчанию: 1)
- `--max-documents` - Максимум документов на задачу (по умолчанию: 100)
- `--dry-run` - Показать какие задачи будут созданы, но не создавать их

### Примеры

#### Загрузка за 2024 год по месяцам
```bash
python create_tasks_by_date.py \
    --api-url https://gate-server.com \
    --year 2024 \
    --period month \
    --court-region 11 \
    --instance-type 1 \
    --max-documents 500 \
    --api-key YOUR_API_KEY
```

Это создаст 12 задач:
- Задача 1: 01.01.2024 - 31.01.2024
- Задача 2: 01.02.2024 - 29.02.2024
- Задача 3: 01.03.2024 - 31.03.2024
- ... и так далее

#### Загрузка за 2024 год по кварталам
```bash
python create_tasks_by_date.py \
    --api-url https://gate-server.com \
    --year 2024 \
    --period quarter \
    --api-key YOUR_API_KEY
```

Это создаст 4 задачи:
- Q1: 01.01.2024 - 31.03.2024
- Q2: 01.04.2024 - 30.06.2024
- Q3: 01.07.2024 - 30.09.2024
- Q4: 01.10.2024 - 31.12.2024

#### Проверка перед созданием (dry-run)
```bash
python create_tasks_by_date.py \
    --api-url https://gate-server.com \
    --year 2024 \
    --period month \
    --dry-run
```

Это покажет все задачи, которые будут созданы, но не создаст их.

## Схема работы системы

```
┌─────────────────────────────────────────┐
│  1. Администратор запускает скрипт     │
│     create_tasks_by_date.py            │
│     --year 2024 --period month         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  2. Скрипт разбивает год на периоды    │
│     - Январь 2024: 01.01 - 31.01       │
│     - Февраль 2024: 01.02 - 29.02      │
│     - ...                               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. Для каждого периода создается      │
│     задача через API /tasks/create      │
│     с RegDateBegin и RegDateEnd         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  4. Задачи сохраняются в БД            │
│     со статусом 'pending'               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  5. Клиенты запрашивают задачи         │
│     через /tasks/request                │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  6. Сервер назначает задачи клиентам   │
│     (FIFO - первая созданная первая)    │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  7. Клиенты обрабатывают задачи        │
│     и загружают документы               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  8. Клиенты сообщают о результате       │
│     через /tasks/complete               │
└─────────────────────────────────────────┘
```

## Структура задачи

Каждая задача содержит:

```json
{
  "search_params": {
    "CourtRegion": "11",
    "INSType": "1",
    "ChairmenName": "",
    "SearchExpression": "",
    "RegDateBegin": "01.01.2024",
    "RegDateEnd": "31.01.2024",
    "DateFrom": "",
    "DateTo": ""
  },
  "start_page": 1,
  "max_documents": 100
}
```

## Рекомендации

### Выбор типа периода

- **Месяцы** (рекомендуется) - оптимальный баланс между количеством задач и объемом данных
- **Кварталы** - для очень больших объемов, меньше задач, но больше документов на задачу
- **Недели** - для более детального контроля, но больше задач
- **Дни** - только для очень специфических случаев, создает много задач

### Настройка max_documents

- Если документов в периоде немного (< 1000), можно использовать `--max-documents 1000`
- Если документов много, лучше оставить `--max-documents 100` и разбить на страницы
- Можно создать несколько задач для одного периода с разными `start_page`

### Мониторинг

После создания задач можно проверить их статус:

```bash
curl -H "X-API-Key: YOUR_API_KEY" \
  https://gate-server.com/api/v1/tasks?status_filter=pending
```

## Пример полного workflow

```bash
# 1. Создать задачи за 2024 год по месяцам
python create_tasks_by_date.py \
    --api-url https://gate-server.com \
    --year 2024 \
    --period month \
    --api-key YOUR_API_KEY

# 2. Запустить клиентов (на разных хостах)
# Host 1:
python downloader_client.py \
    --api-url https://gate-server.com \
    --api-key YOUR_API_KEY \
    --client-name client-1

# Host 2:
python downloader_client.py \
    --api-url https://gate-server.com \
    --api-key YOUR_API_KEY \
    --client-name client-2

# 3. Мониторить прогресс
curl -H "X-API-Key: YOUR_API_KEY" \
  https://gate-server.com/api/v1/tasks
```

## Преимущества схемы

1. **Автоматическое распределение** - сервер сам распределяет задачи между клиентами
2. **Масштабируемость** - можно добавить больше клиентов для ускорения
3. **Отказоустойчивость** - если клиент упал, задача вернется в pending и будет назначена другому
4. **Гибкость** - можно создавать задачи для разных периодов, регионов, инстанций
5. **Контроль** - видно прогресс каждой задачи и общую статистику
