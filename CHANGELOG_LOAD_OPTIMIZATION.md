# Changelog: Оптимизация для нагрузки 10 клиентов × 20 одновременных вызовов

## Дата: 2024-01-XX

### Критические исправления

#### 1. Увеличен пул соединений с БД
- **Было:** `maxconn=10` (жестко закодировано)
- **Стало:** `maxconn=250` (настраивается через `DB_POOL_MAXCONN`)
- **Файлы:**
  - `server/config.py` - добавлены настройки `db_pool_minconn`, `db_pool_maxconn`
  - `server/database/connection.py` - использование настроек из конфига

#### 2. Добавлен Redis для кэширования
- **Новое:** Полноценная система кэширования API запросов и результатов БД
- **Файлы:**
  - `docker-compose.yml` - добавлен сервис Redis
  - `server/database/cache.py` - новый модуль для работы с кэшем
  - `server/api/routes.py` - добавлено кэширование в эндпоинты
  - `server/config.py` - настройки Redis и TTL кэша
  - `requirements.txt` - добавлена зависимость `redis>=5.0.0`

**Кэшируется:**
- Список задач (TTL: 10 сек)
- Статистика клиентов (TTL: 30 сек)
- Документы (TTL: 60 сек)
- Сводка задач (TTL: 10 сек)

#### 3. Автоматический backup/restore БД
- **Новое:** Скрипты для автоматического создания и восстановления бэкапов
- **Файлы:**
  - `backup_database.sh` - создание бэкапа с автоматическим сжатием
  - `restore_database.sh` - восстановление из бэкапа

**Особенности:**
- Автоматическое сжатие бэкапов (gzip)
- Автоматическая очистка старых бэкапов (старше 30 дней)
- Поддержка переменных окружения для настроек БД

#### 4. Глобальный rate limiting в nginx
- **Было:** Rate limiting только для `/api/v1/tasks/request`
- **Стало:** Глобальный rate limiting для всех API эндпоинтов
- **Файл:** `nginx.conf`

**Лимиты:**
- Глобальный: 50 запросов/сек на IP (поддержка 10 клиентов × 20 запросов)
- Запросы задач: 10 запросов/сек на IP
- Статистика: 5 запросов/сек на IP

### Документация

#### Новые документы:
- `LOAD_ANALYSIS.md` - детальный анализ проблем и решений
- `LOAD_OPTIMIZATION_GUIDE.md` - руководство по использованию новых функций
- `CHANGELOG_LOAD_OPTIMIZATION.md` - этот файл

### Переменные окружения

#### Новые переменные:

**Пул соединений БД:**
- `DB_POOL_MINCONN` (по умолчанию: 10)
- `DB_POOL_MAXCONN` (по умолчанию: 250)

**Redis:**
- `REDIS_HOST` (по умолчанию: 127.0.0.1)
- `REDIS_PORT` (по умолчанию: 6379)
- `REDIS_DB` (по умолчанию: 0)
- `REDIS_PASSWORD` (опционально)
- `CACHE_ENABLED` (по умолчанию: true)

**TTL кэша:**
- `CACHE_TTL_TASKS` (по умолчанию: 10 секунд)
- `CACHE_TTL_STATISTICS` (по умолчанию: 30 секунд)
- `CACHE_TTL_DOCUMENTS` (по умолчанию: 60 секунд)

### Миграция

#### Шаги для применения изменений:

1. **Обновить зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Запустить Redis:**
   ```bash
   docker-compose up -d redis
   ```

3. **Проверить настройки PostgreSQL:**
   ```sql
   -- Убедиться, что max_connections >= 250
   SHOW max_connections;
   ```

4. **Настроить переменные окружения (опционально):**
   ```bash
   export DB_POOL_MAXCONN=250
   export CACHE_ENABLED=true
   ```

5. **Перезапустить сервер:**
   ```bash
   # Если используется systemd
   sudo systemctl restart reyestr-server
   
   # Или вручную
   python -m uvicorn server.main:app --host 0.0.0.0 --port 8000
   ```

6. **Обновить nginx конфигурацию:**
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

### Обратная совместимость

- ✅ Все изменения обратно совместимы
- ✅ Старые настройки работают с новыми значениями по умолчанию
- ✅ Кэширование можно отключить через `CACHE_ENABLED=false`
- ✅ Redis опционален - система работает без него (с предупреждениями в логах)

### Тестирование

Рекомендуется протестировать:
1. Нагрузочное тестирование с 10 клиентами × 20 запросов
2. Проверка работы кэша (hit rate)
3. Проверка backup/restore процедур
4. Мониторинг использования пула соединений

### Известные ограничения

1. **PostgreSQL max_connections:** Убедитесь, что `max_connections` в PostgreSQL >= `DB_POOL_MAXCONN`
2. **Redis память:** Redis ограничен 256MB по умолчанию (настраивается в docker-compose.yml)
3. **Rate limiting:** Может блокировать легитимные запросы при очень высокой нагрузке

### Следующие шаги (опционально)

1. Переход на `asyncpg` для полностью асинхронных операций с БД
2. Добавление мониторинга и метрик (Prometheus/Grafana)
3. Настройка read replicas для PostgreSQL
4. Оптимизация запросов к БД (индексы, EXPLAIN ANALYZE)
